name: Build Workflow

on:
  workflow_call:
    secrets:
      MONGODB_URI:
        required: false
      BETTER_AUTH_SECRET:
        required: false
      BETTER_AUTH_URL:
        required: false
      FINNHUB_API_KEY:
        required: false
      GEMINI_API_KEY:
        required: false
      NODEMAILER_EMAIL:
        required: false
      NODEMAILER_PASSWORD:
        required: false

env:
  NODE_VERSION: '20.x'

jobs:
  build:
    name: Build, Test, and Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: false

      - name: TypeScript type check
        run: npx tsc --noEmit
        continue-on-error: false

      - name: Run security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for outdated dependencies
        run: npm outdated || true
        continue-on-error: true

      - name: Build application
        env:
          NODE_ENV: production
          NEXT_PHASE: phase-production-build
          MONGODB_URI: ${{ secrets.MONGODB_URI || 'mongodb://localhost:27017/test' }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET || 'dummy-secret-for-build-only' }}
          BETTER_AUTH_URL: ${{ secrets.BETTER_AUTH_URL || 'http://localhost:3000' }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY || 'dummy-key' }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY || 'dummy-key' }}
          NODEMAILER_EMAIL: ${{ secrets.NODEMAILER_EMAIL || 'dummy@example.com' }}
          NODEMAILER_PASSWORD: ${{ secrets.NODEMAILER_PASSWORD || 'dummy-password' }}
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: |
            .next/
            package.json
            package-lock.json
            next.config.ts
            tsconfig.json
          retention-days: 7
          compression-level: 6

      - name: Generate build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dependencies installed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ ESLint passed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ TypeScript type check passed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Security audit completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Artifacts uploaded" >> $GITHUB_STEP_SUMMARY

